define(function(i,L,aa){var Z=brackets.getModule("utils/AppInit"),B=brackets.getModule("utils/ExtensionUtils"),R=brackets.getModule("widgets/Dialogs"),Q=brackets.getModule("document/DocumentManager"),M=brackets.getModule("command/CommandManager"),U=brackets.getModule("command/Commands"),X=brackets.getModule("command/KeyBindingManager"),O=brackets.getModule("editor/EditorManager"),E=brackets.getModule("preferences/PreferencesManager"),V=brackets.getModule("project/ProjectManager"),G=brackets.getModule("command/Menus"),T=brackets.getModule("utils/NodeConnection");var S=G.getContextMenu(G.ContextMenuIds.PROJECT_MENU),K=G.getContextMenu(G.ContextMenuIds.WORKING_SET_MENU),D=null;var C="com.adobe.brackets.jscompressor",N="bracketless.enabled",I=E.getPreferenceStorage(C);var H={is_active_autocompress:I.getValue("enabled"),extensions:["js","css"],compressed_extensions:[".min.js",".min.css"],isValidFile:function(a){return true},autocompress:function(){alert("Activa la compresión automática de archivo js/css")},compressfile:function(){var b=V.getSelectedItem();if(b===null){b=Q.getCurrentDocument().file}var a=b.fullPath;D.domains.nodeexec.runScript(a,null,{module_path:aa.uri.replace("main.js","")}).fail(function(d){console.log("[brackets-jscompressor] error: "+d.toString());var c=R.showModalDialog(R.DIALOG_ID_ERROR,"Run Script Error","The test file contained an error: "+d.toString())})}};H.is_active_autocompress=I.getValue("enabled");var P,W;P=M.register("Autocomprimir","ext.autocompress_cmd",function(){H.is_active_autocompress=!H.is_active_autocompress;var a=M.get("ext.autocompress_cmd");if(!a){return}a.setChecked(H.is_active_autocompress);I.setValue("enabled",H.is_active_autocompress);E.savePreferences();if(H.is_active_autocompress){alert("Ha activado la autocompresión de archivos.\r\n\r\nLa función de autocompresión permite comprimir automáticamente el archivo js/css usando el reconocido compresor YUI en archivos optimizados para la publicación en la web.\r\n\r\nEl resultado será un segundo archivo con el nombre *.min.js/*-min.css en el mismo directorio del archivo original.")}});W=M.register("Construir *.min.js","ext.compressfile_cmd",H.compressfile);var Y=G.getContextMenu(G.ContextMenuIds.PROJECT_MENU);if(Y){Y.addMenuDivider();Y.addMenuItem("ext.autocompress_cmd");Y.addMenuItem("ext.compressfile_cmd")}$(Q).on("documentSaved",function(b,a){if(H.is_active_autocompress){var c=a.file.name.split(".").pop();for(c in H.extensions){if(H.extensions.hasOwnProperty(c)){var d=a.file.fullPath.replace(".js",".css")}}}});function F(a){var b,c="";if(a&&a.isFile){c=a.name.split(".").pop();for(b in H.extensions){if(H.extensions.hasOwnProperty(b)){if(H.extensions[b]===c){return true}}}}return false}$(S).on("beforeContextMenuOpen",function(c){var b=V.getSelectedItem(),a;W.setEnabled(false);if(F(b)){W.setEnabled(true)}});function J(){var b=Array.prototype.slice.call(arguments,0);if(b.length>0){var c=b.shift();var a=c.call();a.done(function(){J.apply(null,b)})}}Z.appReady(function(){D=new T();function b(){var c=D.connect(true);c.fail(function(){console.error("[brackets-jscompressor] failed to connect to node")});return c}function a(){var c=B.getModulePath(aa,"node/NodeExecDomain");var d=D.loadDomains([c],true);d.fail(function(){console.log("[brackets-jscompressor] failed to load node-exec domain")});return d}$(D).on("nodeexec.update",function(d,c){console.log(c)});J(b,a)})});